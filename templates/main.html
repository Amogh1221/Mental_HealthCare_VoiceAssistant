<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Psychiatrist - Dr. Aiden</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    .recording-pulse::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.5);
      animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1e293b;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700/50 sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold text-white">Dr. Aiden</h1>
          <p class="text-xs text-slate-400">AI Psychiatrist</p>
        </div>
      </div>
      <button 
        id="resetBtn" 
        class="px-4 py-2 bg-slate-700/50 hover:bg-slate-700 text-white rounded-lg transition-all duration-200 flex items-center gap-2 text-sm font-medium border border-slate-600"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        New Session
      </button>
    </div>
  </header>

  <!-- Chat Container -->
  <div class="flex-1 overflow-hidden flex flex-col max-w-5xl w-full mx-auto">
    <div id="chatWrapper" class="flex-1 overflow-y-auto px-4 py-6 custom-scrollbar">
      <div id="chat" class="flex flex-col gap-4 max-w-4xl mx-auto"></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="bg-slate-800/30 backdrop-blur-sm border-t border-slate-700/50">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <div class="flex items-center justify-center gap-6">
        <button 
          id="micBtn" 
          class="relative w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 shadow-lg shadow-blue-500/50 transition-all duration-200 flex items-center justify-center group disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
          </svg>
        </button>
      </div>
      
      <div class="text-center mt-4">
        <p id="status" class="text-sm text-slate-400 font-medium"></p>
      </div>
    </div>
  </div>

<script>

let sessionId = null;
let isListening = false;

const chat = document.getElementById("chat");
const chatWrapper = document.getElementById("chatWrapper");
const micBtn = document.getElementById("micBtn");
const resetBtn = document.getElementById("resetBtn");
const statusText = document.getElementById("status");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  alert("Speech Recognition not supported in this browser. Please use Chrome or Edge.");
}

const recognition = new SpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = "en-US";

let currentTranscript = "";
let typingNode = null;
let userStopped = false;

function scrollToBottom() {
  setTimeout(() => {
    chatWrapper.scrollTop = chatWrapper.scrollHeight;
  }, 100);
}

function addMessage(text, role) {
  const messageDiv = document.createElement("div");
  messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
  
  const bubble = document.createElement("div");
  bubble.className = `max-w-[75%] px-5 py-3 rounded-2xl ${
    role === 'user' 
      ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-tr-md' 
      : 'bg-slate-700/50 text-slate-100 rounded-tl-md border border-slate-600/30'
  } shadow-lg`;
  
  bubble.textContent = text;
  messageDiv.appendChild(bubble);
  chat.appendChild(messageDiv);
  scrollToBottom();
}

function addTyping() {
  if (typingNode) return;
  
  const messageDiv = document.createElement("div");
  messageDiv.className = "flex justify-start fade-in";
  
  const bubble = document.createElement("div");
  bubble.className = "px-5 py-4 rounded-2xl rounded-tl-md bg-slate-700/30 border border-slate-600/30";
  
  bubble.innerHTML = `
    <div class="typing-indicator flex gap-1">
      <span></span>
      <span></span>
      <span></span>
    </div>
  `;
  
  messageDiv.appendChild(bubble);
  typingNode = messageDiv;
  chat.appendChild(messageDiv);
  scrollToBottom();
}

function removeTyping() {
  if (!typingNode) return;
  typingNode.remove();
  typingNode = null;
}

function clearChat() {
  chat.innerHTML = "";
}

function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 0.9;
  msg.pitch = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

async function startSession() {
  statusText.textContent = "Initializing session...";
  
  try {
    const response = await fetch("/start", { method: "POST" });
    const data = await response.json();
    sessionId = data.session_id;

    addMessage(data.assistant_message, "assistant");
    speak(data.assistant_message);

    statusText.textContent = "Tap the microphone to speak";
  } catch (error) {
    console.error("Error starting session:", error);
    statusText.textContent = "Error starting session";
  }
}

window.onload = startSession;

resetBtn.onclick = async () => {
  clearChat();
  statusText.textContent = "Starting new session...";

  try {
    const response = await fetch("/reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id: sessionId })
    });

    const data = await response.json();
    sessionId = data.session_id;

    addMessage(data.assistant_message, "assistant");
    speak(data.assistant_message);

    statusText.textContent = "Tap the microphone to speak";
  } catch (error) {
    console.error("Error resetting session:", error);
    statusText.textContent = "Error resetting session";
  }
};

micBtn.onclick = () => {
  if (!isListening) {
    userStopped = false;
    try {
      recognition.start();
    } catch (e) {
      console.warn("Recognition already started");
    }
    isListening = true;
    micBtn.classList.add("recording-pulse", "!from-red-500", "!to-red-600", "!shadow-red-500/50");
    statusText.textContent = "Listening... (tap again to stop)";
  } else {
    userStopped = true;
    recognition.stop();
  }
};

recognition.onresult = (event) => {
  let interim = "";
  for (let i = event.resultIndex; i < event.results.length; ++i) {
    interim += event.results[i][0].transcript;
  }
  currentTranscript = interim;
};

recognition.onend = async () => {
  if (!userStopped) {
    try {
      recognition.start();
      isListening = true;
      statusText.textContent = "Listening... (tap again to stop)";
      return;
    } catch (e) {
      console.warn("Speech recognition restart failed:", e);
    }
  }

  isListening = false;
  userStopped = false;
  micBtn.classList.remove("recording-pulse", "!from-red-500", "!to-red-600", "!shadow-red-500/50");

  if (!currentTranscript || currentTranscript.trim() === "") {
    statusText.textContent = "Tap the microphone to speak";
    return;
  }

  addMessage(currentTranscript.trim(), "user");
  statusText.textContent = "Dr. Aiden is thinking...";
  addTyping();

  try {
    const response = await fetch("/chat_text", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: currentTranscript.trim(),
        session_id: sessionId
      })
    });

    const data = await response.json();

    removeTyping();
    addMessage(data.assistant_message, "assistant");
    speak(data.assistant_message);
    statusText.textContent = "Tap the microphone to speak";
  } catch (err) {
    removeTyping();
    addMessage("I apologize, but I'm having trouble connecting right now. Please try again.", "assistant");
    statusText.textContent = "Connection error - tap to retry";
    console.error("Error:", err);
  }

  currentTranscript = "";
};

recognition.onerror = (event) => {
  console.error("Recognition error:", event.error);
  isListening = false;
  micBtn.classList.remove("recording-pulse", "!from-red-500", "!to-red-600", "!shadow-red-500/50");
  
  if (event.error === 'not-allowed') {
    statusText.textContent = "Microphone access denied";
  } else {
    statusText.textContent = "Tap the microphone to speak";
  }
};

</script>

</body>
</html>